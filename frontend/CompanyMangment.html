<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --accent-color: #e9f2ff;
        }

        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: none;
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 15px 20px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .btn-primary {
            background-color: var(--primary-color);
            border: none;
        }

        .btn-primary:hover {
            background-color: #0b5ed7;
        }

        .table-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            padding: 20px;
        }

        .table-header {
            background-color: var(--accent-color);
        }

        #loader {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .alert {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="text-center text-primary">Company Management System</h1>
        </div>
    </div>

    <!-- Alert messages -->
    <div class="row">
        <div class="col-12">
            <div id="successAlert" class="alert alert-success alert-dismissible fade show" role="alert">
                <span id="successMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div id="errorAlert" class="alert alert-danger alert-dismissible fade show" role="alert">
                <span id="errorMessage"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-5 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Company Information</h5>
                </div>
                <div class="card-body">
                    <form id="companyForm">
                        <div class="mb-3">
                            <label for="c_id" class="form-label">Company ID</label>
                            <input type="number" class="form-control" id="c_id" placeholder="c_id" required>

                        </div>

                        <div class="mb-3">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" required>
                        </div>

                        <div class="mb-3">
                            <label for="companyTypeId" class="form-label">Company Type ID</label>
                            <input type="text" class="form-control" id="companyTypeId" required>
                        </div>

                        <div class="mb-3">
                            <label for="contactEmail" class="form-label">Contact Email</label>
                            <input type="email" class="form-control" id="contactEmail">
                        </div>

                        <div class="mb-3">
                            <label for="contactPhone" class="form-label">Contact Phone</label>
                            <input type="tel" class="form-control" id="contactPhone">
                        </div>

                        <div class="mb-3">
                            <label for="address" class="form-label">Company Address</label>
                            <textarea class="form-control" id="address" rows="3"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" type="submit">Save Company</button>
                            <button class="btn btn-outline-secondary" type="reset">Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="table-container">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Company List</h5>
                    <div class="input-group w-50">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search companies...">
                        <button class="btn btn-outline-primary" type="button" id="searchBtn">Search</button>
                    </div>
                </div>

                <!-- Loader -->
                <div id="loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading data...</p>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-header">
                        <tr>
                            <th>ID</th>
                            <th>Company Name</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="companyTableBody">
                        <!-- Company data will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- Pagination will be dynamically generated -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {

        const API_URL = "http://localhost:8082/api/v1/company";
        const ITEMS_PER_PAGE = 5;
        let companies = [];
        let currentPage = 1;


        loadCompanies();
        $("#companyForm").submit(function(e) {
            e.preventDefault();
            saveCompany();
        });

        // Clear form button
        $("button[type='reset']").click(function() {
            $("#companyId").val("");
        });

        // Search button click
        $("#searchBtn").click(function() {
            searchCompanies();
        });

        // Search on enter key
        $("#searchInput").keypress(function(e) {
            if (e.which === 13) {
                searchCompanies();
            }
        });

        // Function to load all companies
        function loadCompanies() {
            showLoader(true);

            $.ajax({
                url: API_URL + "/getAll",
                type: "GET",
                contentType: "application/json",
                success: function(response) {
                    showLoader(false);

                    if (response.code === 200) {
                        companies = response.data || [];
                        displayCompanies(companies);
                        setupPagination(companies.length);
                    } else {
                        showError("Failed to load companies: " + response.message);
                    }
                },
                error: function(xhr) {
                    showLoader(false);
                    showError("Error loading companies: " + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }

        // Function to display companies in the table with pagination
        function displayCompanies(companyList) {
            const tableBody = $("#companyTableBody");
            tableBody.empty();

            if (!companyList || companyList.length === 0) {
                tableBody.append("<tr><td colspan='4' class='text-center'>No companies found</td></tr>");
                return;
            }

            // Calculate which items to show based on current page
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = Math.min(startIndex + ITEMS_PER_PAGE, companyList.length);
            const pageCompanies = companyList.slice(startIndex, endIndex);

            // Populate table with page companies
            $.each(pageCompanies, function(i, company) {
                // Convert company type ID to text
                let companyTypeText = getCompanyTypeText(company.companyType);

                let row = `<tr>
                <td>${company.c_id}</td>
                <td>${company.companyName}</td>
                <td>${company.companyTypeId}</td>
                <td>${company.email}</td>
                <td>${company.contactNumber}</td>
                <td>${company.address}</td>



                <td>
                    <button class="btn btn-sm btn-primary me-1 edit-btn" data-id="${company.id}">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn" data-id="${company.id}">Delete</button>
                </td>
            </tr>`;

                tableBody.append(row);
            });

            // Add edit button click event
            $(".edit-btn").click(function() {
                let companyId = $(this).data("id");
                getCompanyById(companyId);
            });

            // Add delete button click event
            $(".delete-btn").click(function() {
                // let companyId = $(this).data("c_id");
                let companyId = $("#c_id").val().trim();
                console.log(companyId);
                deleteCompany(companyId);
            });
        }

        // Function to set up pagination
        function setupPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const pagination = $("#pagination");
            pagination.empty();

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            let prevDisabled = currentPage === 1 ? "disabled" : "";
            pagination.append(`
            <li class="page-item ${prevDisabled}">
                <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>
        `);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                let active = i === currentPage ? "active" : "";
                pagination.append(`
                <li class="page-item ${active}">
                    <a class="page-link" href="#" data-page="${i}">${i}</a>
                </li>
            `);
            }

            // Next button
            let nextDisabled = currentPage === totalPages ? "disabled" : "";
            pagination.append(`
            <li class="page-item ${nextDisabled}">
                <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>
        `);

            // Add click event to pagination
            $(".page-link").click(function(e) {
                e.preventDefault();
                const page = $(this).data("page");

                // Check if valid page and not disabled
                if (page >= 1 && page <= totalPages && !$(this).parent().hasClass("disabled")) {
                    currentPage = page;
                    displayCompanies(companies);
                    setupPagination(totalItems);
                }
            });
        }


        function getCompanyTypeText(typeId) {
            switch (parseInt(typeId)) {
                case 1: return "Admin";
                case 2: return "Bios";
                case 3: return "Partnership";
                case 4: return "Sole Proprietorship";
                case 5: return "Non-Profit Organization";
                default: return "Unknown";
            }
        }


        function getCompanyById(id) {
            showLoader(true);

            $.ajax({
                url: API_URL + "/" + id,
                type: "GET",
                contentType: "application/json",
                success: function(response) {
                    showLoader(false);

                    if (response.code === 200 && response.data) {
                        fillCompanyForm(response.data);
                    } else {
                        showError("Failed to get company: " + response.message);
                    }
                },
                error: function(xhr) {
                    showLoader(false);
                    showError("Error getting company: " + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }


        function fillCompanyForm(company) {
            $("#companyId").val(company.id);
            $("#companyName").val(company.name);
            $("#companyType").val(company.companyType);
            $("#contactEmail").val(company.email || "");
            $("#contactPhone").val(company.phone || "");
            $("#address").val(company.address || "");

            // Scroll to form
            $("html, body").animate({
                scrollTop: $("#companyForm").offset().top - 50
            }, 500);
        }

        function saveCompany() {
            if (!$("#companyForm")[0].checkValidity()) {
                $("#companyForm")[0].reportValidity();
                return;
            }

            let companyData = {
                c_id:$("#c_id").val().trim(),
                companyName: $("#companyName").val().trim(),
                companyTypeId: $("#companyTypeId").val(),
                email: $("#contactEmail").val().trim(),
                contactNumber: $("#contactPhone").val().trim(),
                address: $("#address").val().trim()
            };

            let companyId = $("#companyId").val();
            let url = API_URL + "/save";
            let type = "POST";
            let successMsg = "Company saved successfully!";

            // If ID exists, it's an update
            if (companyId) {
                companyData.id = parseInt(companyId);
                url = API_URL + "/update";
                type = "PUT";
                successMsg = "Company updated successfully!";
            }

            showLoader(true);

            $.ajax({
                url: url,
                type: type,
                contentType: "application/json",
                data: JSON.stringify(companyData),
                success: function(response) {
                    showLoader(false);

                    if (response.code === 200) {
                        showSuccess(successMsg);
                        resetForm();
                        loadCompanies();
                    } else {
                        showError("Failed: " + response.message);
                    }
                },
                error: function(xhr) {
                    showLoader(false);
                    showError("Error: " + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }

        // Function to delete company
        function deleteCompany(id) {
            if (confirm("Are you sure you want to delete this company?")) {
                showLoader(true);

                $.ajax({
                    url: API_URL + "/delete/" + id,
                    type: "DELETE",
                    contentType: "application/json",
                    success: function(response) {
                        showLoader(false);

                        if (response.code === 200) {
                            showSuccess("Company deleted successfully!");
                            loadCompanies();
                        } else {
                            showError("Failed to delete: " + response.message);
                        }
                    },
                    error: function(xhr) {
                        showLoader(false);
                        showError("Error deleting company: " + (xhr.responseJSON?.message || xhr.statusText));
                    }
                });
            }
        }

        // Function to search companies
        function searchCompanies() {
            let searchTerm = $("#searchInput").val().trim();

            if (!searchTerm) {
                loadCompanies();
                return;
            }

            showLoader(true);

            // Get all companies and filter on client side
            // In a real app, you might want to implement a search endpoint
            $.ajax({
                url: API_URL + "/getAll",
                type: "GET",
                contentType: "application/json",
                success: function(response) {
                    showLoader(false);

                    if (response.code === 200) {
                        const allCompanies = response.data || [];
                        const searchLower = searchTerm.toLowerCase();

                        const filtered = allCompanies.filter(function(company) {
                            return company.name.toLowerCase().includes(searchLower) ||
                                String(company.id).includes(searchTerm);
                        });

                        companies = filtered;
                        currentPage = 1;
                        displayCompanies(filtered);
                        setupPagination(filtered.length);
                    } else {
                        showError("Search failed: " + response.message);
                    }
                },
                error: function(xhr) {
                    showLoader(false);
                    showError("Error searching: " + (xhr.responseJSON?.message || xhr.statusText));
                }
            });
        }

        // Function to reset form
        function resetForm() {
            $("#companyId").val("");
            $("#companyForm")[0].reset();
        }

        // Function to show/hide loader
        function showLoader(show) {
            if (show) {
                $("#loader").show();
            } else {
                $("#loader").hide();
            }
        }

        // Functions to show alerts
        function showSuccess(message) {
            $("#successMessage").text(message);
            $("#successAlert").fadeIn().delay(3000).fadeOut();
        }

        function showError(message) {
            $("#errorMessage").text(message);
            $("#errorAlert").fadeIn().delay(5000).fadeOut();
        }
    });
</script>
</body>
</html>