<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Item Management System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #0d6efd;
            text-align: center;
            margin-bottom: 30px;
            font-weight: bold;
        }
        .card {
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #0d6efd;
            color: white;
            font-size: 18px;
            font-weight: bold;
            padding: 12px 20px;
        }
        .card-body {
            padding: 20px;
        }
        .form-label {
            font-weight: 500;
        }
        .btn-primary {
            background-color: #0d6efd;
            border-color: #0d6efd;
            width: 100%;
        }
        .btn-secondary {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #212529;
            width: 100%;
        }
        .search-container {
            display: flex;
            margin-bottom: 20px;
        }
        .search-container input {
            flex-grow: 1;
            margin-right: 10px;
        }
        .pagination {
            justify-content: center;
            margin-top: 20px;
        }
        .edit-btn {
            margin-right: 5px;
        }
        table {
            width: 100%;
            margin-bottom: 1rem;
            color: #212529;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        th {
            font-weight: 500;
        }
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Item Management System</h1>

    <div class="row">
        <!-- Item Information Form -->
        <div class="col-md-5">
            <div class="card">
                <div class="card-header">Item Information</div>
                <div class="card-body">
                    <form id="itemForm">
                        <label for="itemId" class="form-label">Item ID</label>
                        <input type="text" class="form-control mb-2" id="itemId" required>

                        <div class="mb-3">
                            <label for="productName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>

                        <div class="mb-3">
                            <label for="chassisNumber" class="form-label">Chassis Number</label>
                            <input type="text" class="form-control" id="chassisNumber" required>
                        </div>

                        <div class="mb-3">
                            <label for="registerNumber" class="form-label">Register Number</label>
                            <input type="text" class="form-control" id="registerNumber" required>
                        </div>

                        <div class="mb-3">
                            <label for="brandName" class="form-label">Brand Name</label>
                            <input type="text" class="form-control" id="brandName" required>
                        </div>

                        <div class="mb-3">
                            <label for="image" class="form-label">Image URL</label>
                            <input type="text" class="form-control" id="image" required>
                        </div>

                        <div class="mb-3">
                            <label for="userId" class="form-label">User ID</label>
                            <input type="number" class="form-control" id="userId" required>
                        </div>

                        <div class="mb-3">
                            <button type="submit" class="btn btn-primary" id="saveBtn">Save Item</button>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-secondary" id="clearBtn">Clear Form</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Item List -->
        <div class="col-md-7">
            <div class="card">
                <div class="card-header">Item List</div>
                <div class="card-body">
                    <div class="search-container">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search items...">
                        <button class="btn btn-primary" style="width: auto;" id="searchBtn">Search</button>
                    </div>

                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product Name</th>
                                <th>Brand Name</th>
                                <th>Register Number</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody id="itemTableBody">
                            <!-- Items will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <nav>
                        <ul class="pagination" id="pagination">
                            <li class="page-item"><a class="page-link" href="#" id="prevPage">Previous</a></li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="nextPage">Next</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    // Global variables
    let currentPage = 1;
    const itemsPerPage = 5;
    let allItems = [];

    // Document ready function
    $(document).ready(function() {
        // Load items when page loads
        loadItems();

        // Form submit event
        $("#itemForm").submit(function(e) {
            e.preventDefault();
            saveItem();
        });

        // Clear form button
        $("#clearBtn").click(function() {
            clearForm();
        });

        // Search button
        $("#searchBtn").click(function() {
            searchItems();
        });

        // Enter key in search input
        $("#searchInput").keypress(function(e) {
            if (e.which === 13) {
                searchItems();
            }
        });

        // Pagination events
        $("#prevPage").click(function() {
            if (currentPage > 1) {
                currentPage--;
                displayItems();
                updatePagination();
            }
        });

        $("#nextPage").click(function() {
            const maxPages = Math.ceil(allItems.length / itemsPerPage);
            if (currentPage < maxPages) {
                currentPage++;
                displayItems();
                updatePagination();
            }
        });

        // Page number click
        $(document).on("click", ".page-number", function() {
            currentPage = parseInt($(this).text());
            displayItems();
            updatePagination();
        });
    });


    function loadItems() {
        $.ajax({
            url: "http://localhost:8082/api/items/getall",
            type: "GET",
            dataType: "json",
            success: function(response) {
                allItems = response;
                displayItems();
                updatePagination();
            },
            error: function(xhr, status, error) {
                console.error("Error loading items:", error);
                alert("Failed to load items. Please try again later.");
            }
        });
    }

    // Function to load items by user ID
    function loadItemsByUser(userId) {
        $.ajax({
            url: `http://localhost:8082/api/items/user/${userId}`,
            type: "GET",
            dataType: "json",
            success: function(response) {
                allItems = response;
                displayItems();
                updatePagination();
            },
            error: function(xhr, status, error) {
                console.error("Error loading items for user:", error);
                alert("Failed to load items for the specified user.");
            }
        });
    }

    // Function to save or update an item
    function saveItem() {
        const itemId = $("#itemId").val();
        const item = {
            id: itemId === "" ? 0 : parseInt(itemId), // Set ID to 0 for new items or parse existing ID
            product_name: $("#productName").val(),
            chassis_number: $("#chassisNumber").val(),
            register_number: $("#registerNumber").val(),
            brand_name: $("#brandName").val(),
            image: $("#image").val(),
            user : {
                id: parseInt($("#userId").val())
            }
        };

        // Determine if it's an update or new item
        const isUpdate = itemId !== "";
        const url = isUpdate
            ? `http://localhost:8082/api/items/update/${itemId}`
            : "http://localhost:8082/api/items/save";
        const method = isUpdate ? "PUT" : "POST";

        // Log the request for debugging
        console.log("Sending request to:", url);
        console.log("Request method:", method);
        console.log("Request body:", JSON.stringify(item));

        $.ajax({
            url: url,
            type: method,
            contentType: "application/json",
            data: JSON.stringify(item),
            success: function(response) {
                console.log("Success response:", response);
                alert(isUpdate ? "Item updated successfully!" : "Item saved successfully!");
                clearForm();
                loadItems();
            },
            error: function(xhr, status, error) {
                console.error("Error saving item:", error);
                console.error("Response:", xhr.responseText);
                alert("Failed to save item. Check console for details.");
            }
        });
    }
    // Function to delete an item
    function deleteItem(id) {
        if (confirm("Are you sure you want to delete this item?")) {
            $.ajax({
                url: `http://localhost:8082/api/items/${id}`,
                type: "DELETE",
                success: function() {
                    alert("Item deleted successfully!");
                    loadItems();
                },
                error: function(xhr, status, error) {
                    console.error("Error deleting item:", error);
                    alert("Failed to delete item. Please try again.");
                }
            });
        }
    }

    // Function to edit an item (populate form)
    function editItem(id) {
        const item = allItems.find(item => item.id === id);
        if (item) {
            $("#itemId").val(item.id);
            $("#productName").val(item.product_name);
            $("#chassisNumber").val(item.chassis_number);
            $("#registerNumber").val(item.register_number);
            $("#brandName").val(item.brand_name);
            $("#image").val(item.image);
            $("#userId").val(item.user.id);
            $("#saveBtn").text("Update Item");
        }
    }

    // Function to display items with pagination
    function displayItems() {
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const itemsToDisplay = allItems.slice(startIndex, endIndex);

        $("#itemTableBody").empty();

        if (itemsToDisplay.length === 0) {
            $("#itemTableBody").append(`
            <tr>
                <td colspan="5" class="text-center">No items found</td>
            </tr>
        `);
            return;
        }

        $.each(itemsToDisplay, function(index, item) {
            $("#itemTableBody").append(`
            <tr>
                <td>${item.id}</td>
                <td>${item.product_name}</td>
                <td>${item.brand_name}</td>
                <td>${item.register_number}</td>
                <td>
                    <button class="btn btn-sm btn-primary edit-btn" onclick="editItem(${item.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteItem(${item.id})">Delete</button>
                </td>
            </tr>
        `);
        });
    }

    // Function to update pagination controls
    function updatePagination() {
        const maxPages = Math.ceil(allItems.length / itemsPerPage);

        // Clear existing page numbers
        $("#pagination li:not(:first-child):not(:last-child)").remove();

        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(maxPages, startPage + 4);

        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        for (let i = startPage; i <= endPage; i++) {
            const isActive = i === currentPage ? "active" : "";
            const pageItem = `<li class="page-item ${isActive}"><a class="page-link page-number" href="#">${i}</a></li>`;
            $(pageItem).insertBefore("#nextPage").parent();
        }

        // Enable/disable prev/next buttons
        $("#prevPage").parent().toggleClass("disabled", currentPage === 1);
        $("#nextPage").parent().toggleClass("disabled", currentPage === maxPages || maxPages === 0);
    }

    // Function to search items
    function searchItems() {
        const searchTerm = $("#searchInput").val().toLowerCase();

        if (searchTerm === "") {
            loadItems();
            return;
        }

        // Filter items based on search term
        const filteredItems = allItems.filter(item =>
            item.product_name.toLowerCase().includes(searchTerm) ||
            item.brand_name.toLowerCase().includes(searchTerm) ||
            item.register_number.toLowerCase().includes(searchTerm) ||
            item.chassis_number.toLowerCase().includes(searchTerm)
        );

        allItems = filteredItems;
        currentPage = 1;
        displayItems();
        updatePagination();
    }

    // Function to clear the form
    function clearForm() {
        $("#itemId").val("");
        $("#itemForm")[0].reset();
        $("#saveBtn").text("Save Item");
    }
</script>
</body>
</html>
