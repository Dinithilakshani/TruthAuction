<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Truth Auctions - Admin Panel</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
        }

        .sidebar {
            background-color: #2c3e50;
            color: white;
            min-height: 100vh;
            padding: 20px 0;
        }

        .sidebar .nav-link {
            color: #adb5bd;
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 5px;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: #34495e;
            color: white;
        }

        .sidebar .brand {
            font-size: 24px;
            font-weight: bold;
            padding: 0 20px 20px;
            margin-bottom: 20px;
        }

        .content {
            padding: 20px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
        }

        .time-remaining {
            color: #dc3545;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #0d6efd;
            border: none;
        }

        .auth-buttons {
            margin-top: auto;
            padding: 20px;
        }

        .auth-buttons .btn {
            margin: 5px;
        }

        table th {
            font-weight: 600;
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1100;
            visibility: hidden;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="brand">Truth Auctions</div>
            <nav class="nav flex-column">
                <a class="nav-link" href="#">Home</a>
                <a class="nav-link active" href="#">Auctions</a>
                <a class="nav-link" href="#">How It Works</a>
                <a class="nav-link" href="#">Category</a>
                <a class="nav-link" href="#">Contact</a>
            </nav>
            <div class="auth-buttons">
                <a href="#" class="btn btn-outline-light">Login</a>
                <a href="#" class="btn btn-light">Register</a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-10 content">
            <h2 class="mb-4">Auction Management</h2>

            <!-- Admin Auction Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Admin Auction Table</h5>
                    <button class="btn btn-primary btn-sm">Add New Auction</button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Chassis Number</th>
                                <th>Email</th>
                                <th>Bid Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Table body will be populated with JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div class="spinner-overlay" id="loadingSpinner">
    <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script >
    // auction-management.js - AJAX implementation for Truth Auctions admin panel

    document.addEventListener('DOMContentLoaded', function() {
        // Load all auctions when page loads
        loadAllAuctions();

        // Add event listener for the "Add New Auction" button
        document.querySelector('.card-header .btn-primary').addEventListener('click', function() {
            showAddAuctionModal();
        });
    });

    // Function to load all auctions from the backend
    function loadAllAuctions() {
        fetch('http://localhost:8082/api/v1/auction/getAll')
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    renderAuctionsTable(data.data);
                } else {
                    showAlert('Error loading auctions: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error fetching auctions:', error);
                showAlert('Failed to connect to the server. Please try again later.', 'danger');
            });
    }

    // Function to render the auctions table with data
    function renderAuctionsTable(auctions) {
        const tableBody = document.querySelector('.table tbody');
        tableBody.innerHTML = ''; // Clear existing rows

        auctions.forEach(auction => {
            const row = document.createElement('tr');

            // Create status badge with appropriate color
            let statusBadge = '';
            switch(auction.status) {
                case 'ACTIVE':
                    statusBadge = '<span class="badge bg-success">Active</span>';
                    break;
                case 'CLOSED':
                    statusBadge = '<span class="badge bg-secondary">Closed</span>';
                    break;
                case 'PENDING':
                    statusBadge = '<span class="badge bg-warning text-dark">Pending</span>';
                    break;
                default:
                    statusBadge = '<span class="badge bg-info">Unknown</span>';
            }

            row.innerHTML = `
            <td>${auction.id}</td>
            <td>${auction.chassi_number}</td>
            <td>${auction.email}</td>
            <td>$${formatPrice(auction.bid_price)}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-info edit-btn" data-id="${auction.id}">Edit</button>
                <button class="btn btn-sm btn-danger delete-btn" data-id="${auction.id}">Delete</button>
            </td>
        `;

            tableBody.appendChild(row);
        });

        // Add event listeners to edit and delete buttons
        addActionButtonListeners();
    }

    // Add event listeners to action buttons
    function addActionButtonListeners() {
        // Edit button listeners
        document.querySelectorAll('.edit-btn').forEach(button => {
            button.addEventListener('click', function() {
                const auctionId = this.getAttribute('data-id');
                editAuction(auctionId);
            });
        });

        // Delete button listeners
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', function() {
                const auctionId = this.getAttribute('data-id');
                confirmDeleteAuction(auctionId);
            });
        });
    }

    // Format price with commas
    function formatPrice(price) {
        return parseFloat(price).toLocaleString();
    }

    // Function to show the add auction modal
    function showAddAuctionModal() {
        // Create modal HTML
        const modalHtml = `
        <div class="modal fade" id="addAuctionModal" tabindex="-1" aria-labelledby="addAuctionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addAuctionModalLabel">Add New Auction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addAuctionForm">
                            <div class="mb-3">
                                <label for="chassisNumber" class="form-label">Chassis Number</label>
                                <input type="text" class="form-control" id="chassisNumber" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label for="bidPrice" class="form-label">Bid Price</label>
                                <input type="number" class="form-control" id="bidPrice" required>
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Status</label>
                                <select class="form-select" id="status" required>
                                    <option value="ACTIVE">Active</option>
                                    <option value="PENDING">Pending</option>
                                    <option value="CLOSED">Closed</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveAuctionBtn">Save Auction</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Append modal to body if it doesn't exist
        if (!document.getElementById('addAuctionModal')) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        }

        // Create Bootstrap modal instance and show it
        const modal = new bootstrap.Modal(document.getElementById('addAuctionModal'));
        modal.show();

        // Add event listener for the save button
        document.getElementById('saveAuctionBtn').addEventListener('click', saveAuction);
    }

    // Function to save a new auction
    function saveAuction() {
        // Collect form data
        const auction = {
            chassisNumber: document.getElementById('chassisNumber').value,
            email: document.getElementById('email').value,
            bidPrice: document.getElementById('bidPrice').value,
            status: document.getElementById('status').value
        };

        // Send POST request to backend
        fetch('http://localhost:8080/api/v1/auction/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(auction)
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('addAuctionModal')).hide();

                    // Show success message
                    showAlert('Auction saved successfully!', 'success');

                    // Reload auctions
                    loadAllAuctions();
                } else {
                    showAlert('Error saving auction: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving auction:', error);
                showAlert('Failed to connect to the server. Please try again later.', 'danger');
            });
    }

    // Function to edit an auction
    function editAuction(auctionId) {
        // Fetch the auction details by ID
        fetch(`http://localhost:8082/api/v1/auction/${auctionId}`)
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const auction = data.data;
                    showEditAuctionModal(auction);
                } else {
                    showAlert('Error loading auction details: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error fetching auction details:', error);
                showAlert('Failed to connect to the server. Please try again later.', 'danger');
            });
    }

    // Function to show the edit auction modal
    function showEditAuctionModal(auction) {
        // Create modal HTML
        const modalHtml = `
        <div class="modal fade" id="editAuctionModal" tabindex="-1" aria-labelledby="editAuctionModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editAuctionModalLabel">Edit Auction</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editAuctionForm">
                            <input type="hidden" id="editId" value="${auction.id}">
                            <div class="mb-3">
                                <label for="editChassisNumber" class="form-label">Chassis Number</label>
                                <input type="text" class="form-control" id="editChassisNumber" value="${auction.chassisNumber}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editEmail" class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" value="${auction.email}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editBidPrice" class="form-label">Bid Price</label>
                                <input type="number" class="form-control" id="editBidPrice" value="${auction.bidPrice}" required>
                            </div>
                            <div class="mb-3">
                                <label for="editStatus" class="form-label">Status</label>
                                <select class="form-select" id="editStatus" required>
                                    <option value="ACTIVE" ${auction.status === 'ACTIVE' ? 'selected' : ''}>Active</option>
                                    <option value="PENDING" ${auction.status === 'PENDING' ? 'selected' : ''}>Pending</option>
                                    <option value="CLOSED" ${auction.status === 'CLOSED' ? 'selected' : ''}>Closed</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="updateAuctionBtn">Update Auction</button>
                    </div>
                </div>
            </div>
        </div>
    `;

        // Append modal to body if it doesn't exist
        if (!document.getElementById('editAuctionModal')) {
            const modalContainer = document.createElement('div');
            modalContainer.innerHTML = modalHtml;
            document.body.appendChild(modalContainer);
        } else {
            document.getElementById('editAuctionModal').innerHTML = modalHtml;
        }

        // Create Bootstrap modal instance and show it
        const modal = new bootstrap.Modal(document.getElementById('editAuctionModal'));
        modal.show();

        // Add event listener for the update button
        document.getElementById('updateAuctionBtn').addEventListener('click', updateAuction);
    }

    // Function to update an auction
    function updateAuction() {
        // Collect form data
        const auction = {
            id: document.getElementById('editId').value,
            chassisNumber: document.getElementById('editChassisNumber').value,
            email: document.getElementById('editEmail').value,
            bidPrice: document.getElementById('editBidPrice').value,
            status: document.getElementById('editStatus').value
        };

        // Send PUT request to backend
        fetch('http://localhost:8080/api/v1/auction/update', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(auction)
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    // Hide modal
                    bootstrap.Modal.getInstance(document.getElementById('editAuctionModal')).hide();

                    // Show success message
                    showAlert('Auction updated successfully!', 'success');

                    // Reload auctions
                    loadAllAuctions();
                } else {
                    showAlert('Error updating auction: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error updating auction:', error);
                showAlert('Failed to connect to the server. Please try again later.', 'danger');
            });
    }

    // Function to confirm auction deletion
    function confirmDeleteAuction(auctionId) {
        if (confirm('Are you sure you want to delete this auction?')) {
            deleteAuction(auctionId);
        }
    }

    // Function to delete an auction
    function deleteAuction(auctionId) {
        fetch(`http://localhost:8082/api/v1/auction/delete/${auctionId}`, {
            method: 'DELETE'
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    showAlert('Auction deleted successfully!', 'success');
                    loadAllAuctions();
                } else {
                    showAlert('Error deleting auction: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error deleting auction:', error);
                showAlert('Failed to connect to the server. Please try again later.', 'danger');
            });
    }

    // Function to show alerts
    function showAlert(message, type) {
        // Create alert HTML
        const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;

        // Create alert container if it doesn't exist
        let alertContainer = document.querySelector('.alert-container');
        if (!alertContainer) {
            alertContainer = document.createElement('div');
            alertContainer.className = 'alert-container';
            alertContainer.style.position = 'fixed';
            alertContainer.style.top = '20px';
            alertContainer.style.right = '20px';
            alertContainer.style.zIndex = '1050';
            document.body.appendChild(alertContainer);
        }

        // Append alert to container
        const alertElement = document.createElement('div');
        alertElement.innerHTML = alertHtml;
        alertContainer.appendChild(alertElement.firstChild);

        // Auto remove alert after 5 seconds
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            if (alerts.length > 0) {
                const alert = alerts[0];
                bootstrap.Alert.getInstance(alert)?.close();
            }
        }, 5000);
    }
</script>
</body>
</html>